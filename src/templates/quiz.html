<!-- src/templates/quiz.html -->
{% extends "base.html" %}
{% from "macros.html" import helper_innerHTML_functions, letterCard, fetchAlphabet %}
{% block meta_description_additional %}Test your knowledge of the Armenian alphabet with this quiz.{% endblock %}
{% block head_scripts %}
    {{ helper_innerHTML_functions() }}
    {{ fetchAlphabet() }}
    <script>
        const categories = ["uppercase", "lowercase", "handwritten", "transcription", "pronunciation"];
        const learningCategories = ["uppercase", "lowercase", "handwritten"];
        const explainingCategories = ["transcription", "pronunciation", "handwritten"];

        async function getQuestion() {
            const alphabet = await fetchAlphabet();
            let {questionCategory, answerCategory} = getSelectedCategories(categories);

            let question = randomSelectFrom(alphabet[questionCategory]);
            let correctIndex = alphabet[questionCategory].indexOf(question);
            let answer = {};
            for (let category of categories)
                answer[category] = alphabet[category][correctIndex];
            let choices = randomSampleIncluding(alphabet[answerCategory], 4, answer[answerCategory]);

            displayQuestion(question, choices, answerCategory, answer);
        }

        function randomSelectFrom(array, excluding = []) {
            let filteredArray = array.filter(element => !excluding.includes(element));
            return filteredArray[Math.floor(Math.random() * filteredArray.length)];
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1)); // random index from 0 to i
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // returns a random sample of the array with the specified sample size including the specified element
        function randomSampleIncluding(array, sampleSize, element) {
            shuffle(array);
            let sample = array.slice(0, sampleSize);
            if (!sample.includes(element))
                sample[Math.floor(Math.random() * sampleSize)] = element;
            return sample;
        }

        function SelectSecondCategoryRandom(firstCategory, excluding = []) {
            let otherCategory = learningCategories.includes(firstCategory) ? explainingCategories : learningCategories;
            return randomSelectFrom(otherCategory, excluding);
        }

        // When one of the selected categories is a learning category, the other should be an explaining category
        // the selected category should be random if the selected category is not in the list of categories
        function getSelectedCategories(categories) {
            let questionCategory = document.querySelector(`input[name="questionCategory"]:checked`).value;
            let answerCategory = document.querySelector(`input[name="answerCategory"]:checked`).value;

            if (questionCategory === "random" && answerCategory === "random") {
                questionCategory = randomSelectFrom(categories);
            }
            if (answerCategory === "random") {
                answerCategory = SelectSecondCategoryRandom(questionCategory, ["pronunciation", questionCategory]);
            } else if (questionCategory === "random") {
                questionCategory = SelectSecondCategoryRandom(answerCategory, [answerCategory]);
            }

            return {questionCategory, answerCategory};
        }

        function displayQuestion(question, choices, answerCategory, answer) {
            const questionElement = document.getElementById("question");
            const choicesElement = document.getElementById("choices");
            const feedbackElement = document.getElementById("feedback");
            choicesElement.innerHTML = "";
            feedbackElement.textContent = ""; // Clear feedback
            addToElement(question, questionElement);

            choices.forEach((choice) => {
                let element;
                element = document.createElement("button");
                addToElement(choice, element);
                element.className = "btn btn-primary btn-block mb-2";
                element.onclick = () =>
                    onAnswerClick(choice, answerCategory, answer);
                choicesElement.appendChild(element);
            });
        }

        function onAnswerClick(choice, answerCategory, answer) {
            const feedbackElement = document.getElementById("feedback");
            const choicesElement = document.getElementById("choices");
            if (choice === answer[answerCategory]) {
                feedbackElement.textContent = "Correct!";
                feedbackElement.className = "text-success";
                setTimeout(getQuestion, 600); // Fetch new question after 1.5 seconds
            } else {
                feedbackElement.textContent = "Incorrect!";
                feedbackElement.className = "text-danger";
                choicesElement.innerHTML = ""; // Remove answer buttons
                displayAnswerCard(answer);
            }
        }

        function displayAnswerCard(answer) {
            $('#infoCard').show();
            for (let category in answer) {
                const detailsCard = document.getElementById(category);
                addToElement(answer[category], detailsCard);
            }
        }

        function closeCard() {
            $('#infoCard').hide();
            getQuestion();
        }
    </script>
{% endblock %}
{% block body_attributes %}onload="getQuestion()"{% endblock %}
{% block body_content %}
    <div class="container-sm card mt-1 text-center">
        <div class="card-body">
            <div class="d-grid grid title-option">
                <h1 class="card-title">Quiz</h1>
                <!-- Dropdown for Question and Answer Category -->
                <div class="d-flex justify-content-end align-items-center">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        Options
                    </button>
                    <div class="dropdown-menu">
                        <form class="dropdown-item-text">
                            <h5>Question Category:</h5>
                            {% for category in ["uppercase", "lowercase", "transcription", "pronunciation", "handwritten", "random"] %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="questionCategory"
                                           id="question{{ category }}"
                                           value="{{ category }}" {% if category == "random" %}checked{% endif %}/>
                                    <label class="form-check-label"
                                           for="question{{ category }}">{{ category|capitalize }}</label>
                                </div>
                            {% endfor %}
                        </form>
                        <hr class="dropdown-divider">
                        <form class="dropdown-item-text">
                            <h5>Answer Category:</h5>
                            {% for category in ["uppercase", "lowercase", "transcription", "pronunciation", "handwritten", "random"] %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="answerCategory"
                                           id="answer{{ category }}"
                                           value="{{ category }}" {% if category == "random" %}checked{% endif %}/>
                                    <label class="form-check-label"
                                           for="answer{{ category }}">{{ category|capitalize }}</label>
                                </div>
                            {% endfor %}
                        </form>
                    </div>
                </div>
            </div>
            <hr/>
            <!-- Display Question and Choices -->
            <div id="question"></div>
            <div id="feedback"></div>
            <div id="choices" class="d-grid"></div>
            <!-- Info Card for Incorrect Answer -->
            <div id="infoCard" class="card mt-1" style="display: none">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title answer-card-title">Correct Answer Details</h5>
                    {{ letterCard() }}
                    <button class="btn btn-primary btn-lg" onclick="closeCard()">Next</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block end_scripts %}
{% endblock %}
